name: Veracode Pipeline Scan - Webhook Test

on:
  workflow_dispatch:

jobs:
  pipeline_scan:
    runs-on: ubuntu-latest
    name: Veracode Pipeline Scan (Send results payload to webhook.site)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Compacta o projeto rapidamente (evitando node_modules e outras pastas pesadas)
      - name: Create package for scan (zip)
        run: |
          zip -r app.zip . \
            -x "node_modules/*" ".git/*" ".github/*"

      - name: Run Veracode Pipeline Scan
        uses: veracode/Veracode-pipeline-scan-action@v1.0.20
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          file: "app.zip"
          fail_build: false

      - name: Ensure results.json exists
        run: |
          echo "Arquivos gerados:"
          ls -lh
          test -f results.json || (echo "results.json N√ÉO encontrado" && exit 1)

      - name: Send results.json to Bantuu webhook
        env:
          REPOSITORY_FULL_NAME: ${{ github.repository }}
          STOCK_ISSUES_API_KEY: ${{ secrets.STOCK_ISSUES_API_KEY }}
        run: |
          echo "Instalando jq..."
          sudo apt-get update -y
          sudo apt-get install -y jq

          echo "Montando payload JSON..."
          payload=$(jq -c --arg repo "$REPOSITORY_FULL_NAME" \
            '. as $scan | {repositoryFullName: $repo, scanResult: $scan}' results.json)

          echo "Enviando payload para API..."
          curl -X POST "https://good-drab-five.vercel.app/api/veracode/stock-issues/upload" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $STOCK_ISSUES_API_KEY" \
            -d "$payload"
