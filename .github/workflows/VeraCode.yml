name: Veracode Autopackager + Pipeline Scan + Fix (Rigorosa-Teste)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  sast_autofix:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write

    env:
      VERACODE_API_ID: ${{ secrets.VERACODE_API_ID }}
      VERACODE_API_KEY: ${{ secrets.VERACODE_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1️⃣ Instalar Veracode CLI (coloca no PATH)
      - name: Install Veracode CLI
        shell: bash
        run: |
          set -euo pipefail
          echo ">> Instalando Veracode CLI"
          curl -fsSL https://tools.veracode.com/veracode-cli/install | sh
          sudo mv ./veracode /usr/local/bin/veracode
          veracode version

      # 2️⃣ Autopackager (não interativo)
      - name: Auto-package source into artifact (non-interactive)
        id: autopack
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p veracode_artifacts
          echo ">> Rodando autopackager"
          # responde aos dois prompts de confiança
          printf 'y\ny\n' | veracode package --source . --output veracode_artifacts
          echo ">> Artefatos gerados:"
          ls -la veracode_artifacts
          ARTIFACT_PATH="$(ls -1 veracode_artifacts/*.zip | head -n 1)"
          echo "artifact_path=${ARTIFACT_PATH}" >> "$GITHUB_OUTPUT"

      # (opcional) guarda o ZIP como artefato no workflow
      - name: Upload packaged artifact
        uses: actions/upload-artifact@v4
        with:
          name: veracode-artifact
          path: ${{ steps.autopack.outputs.artifact_path }}

      # 3️⃣ Pipeline Scan (política Rigorosa-Teste) + saída JSON
      - name: Veracode Pipeline Scan (Rigorosa-Teste)
        id: pipeline_scan
        uses: veracode/Veracode-pipeline-scan-action@v1.0.12
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          file: ${{ steps.autopack.outputs.artifact_path }}
          veracode_policy_name: "Rigorosa-Teste"
          fail_build: true
          json_output: true
          json_output_file: "results.json"

      # 4️⃣ Veracode Fix — corrige tudo o que for suportado
      - name: Veracode Fix (auto PR)
        if: always()
        uses: veracode/veracode-fix@v1.0.4
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          inputFile: results.json
          fixType: all                # ⚙️ aplica correções em todos os arquivos suportados
          language: javascript        # ajuda o modelo a focar no stack JS
          createPR: true
          prComment: true
          codeSuggestion: true
          emailForCommits: "github-actions[bot]@users.noreply.github.com"
          token: ${{ secrets.GITHUB_TOKEN }}
