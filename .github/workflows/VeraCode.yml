name: Veracode Pipeline Scan - Webhook Test

on:
  workflow_dispatch:

jobs:
  pipeline_scan:
    runs-on: ubuntu-latest
    name: Veracode Pipeline Scan (Send results payload to webhook.site)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Compacta o projeto rapidamente (evitando node_modules e outras pastas pesadas)
      - name: Create package for scan (zip)
        run: |
          zip -r app.zip . \
            -x "node_modules/*" ".git/*" ".github/*"

      - name: Run Veracode Pipeline Scan
        uses: veracode/Veracode-pipeline-scan-action@v1.0.20
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          file: "app.zip"
          fail_build: false

      - name: Ensure results.json exists
        run: |
          echo "Arquivos gerados:"
          ls -lh
          test -f results.json || (echo "results.json NÃƒO encontrado" && exit 1)

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Build payload JSON (repo + branch + commit + results.json)
        env:
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          COMMIT: ${{ github.sha }}
        run: |
          echo "Montando payload..."

          jq -n \
            --arg repo "$REPO_URL" \
            --arg branch "$BRANCH" \
            --arg commit "$COMMIT" \
            --slurpfile results results.json \
            '{
              repository: $repo,
              branch: $branch,
              commit: $commit,
              results: $results[0]
            }' > payload.json

          echo "Payload final:"
          cat payload.json

      - name: Send payload to webhook.site
        run: |
          curl --fail -X POST "https://webhook.site/ce8517ac-56d4-49fe-ab63-9b9e177438a6" \
            -H "Content-Type: application/json" \
            --data-binary @payload.json
