name: Veracode Autopackager + Pipeline Scan + Fix (Rigorosa-Teste)

on:
  workflow_dispatch:

jobs:
  sast_autofix:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write

    env:
      .VERACODE_API_ID: ${{ secrets.VERACODE_API_ID }}
      VERACODE_API_KEY: ${{ secrets.VERACODE_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Instalar Veracode CLI oficialmente
      - name: Install Veracode CLI
        shell: bash
        run: |
          set -euo pipefail
          echo ">> Instalando Veracode CLI"
          curl -fsSL https://tools.veracode.com/veracode-cli/install | sh
          # mover binário pra um local conhecido no PATH
          sudo mv ./veracode /usr/local/bin/veracode
          veracode version

      # 2) Autopackager (gera artefato ZIP automaticamente)
      - name: Auto-package source into artifact
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p veracode_artifacts
          echo ">> Rodando autopackager"
          veracode package --source . --output veracode_artifacts
          echo ">> Artefatos gerados:"
          ls -la veracode_artifacts

      # 3) Pipeline Scan (política Rigorosa-Teste + JSON)
      - name: Veracode Pipeline Scan (Rigorosa-Teste)
        id: pipeline_scan
        uses: veracode/Veracode-pipeline-scan-action@v1.0.12
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          file: "veracode_artifacts/$(ls veracode_artifacts | head -n 1)"
          veracode_policy_name: "Rigorosa-Teste"
          fail_build: true
          json_output: true
          json_output_file: "results.json"

      # 4) Veracode Fix - cria PR com correções automáticas
      - name: Veracode Fix (auto PR)
        if: always()
        uses: veracode/veracode-fix@v1.0.4
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          inputFile: results.json
          createPR: true
          prComment: true
          codeSuggestion: true
          emailForCommits: "github-actions[bot]@users.noreply.github.com"
