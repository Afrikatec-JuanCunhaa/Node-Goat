name: Veracode Pipeline Scan - Webhook Test

on:
  workflow_dispatch:

jobs:
  pipeline_scan:
    runs-on: ubuntu-latest
    name: Veracode Pipeline Scan (Send results.json to webhook.site)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Empacota o projeto em um zip pequeno (ignora coisas pesadas/desnecessárias)
      - name: Create package for scan (zip)
        run: |
          zip -r app.zip . \
            -x "node_modules/*" ".git/*" ".github/*"

      - name: Run Veracode Pipeline Scan
        uses: veracode/Veracode-pipeline-scan-action@v1.0.20
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          file: "app.zip"
          fail_build: false  # como é teste, melhor não quebrar a pipeline

      - name: Ensure results.json exists
        run: |
          echo "Listando arquivos gerados:"
          ls -lh
          test -f results.json || (echo "results.json NÃO encontrado" && exit 1)

      - name: Send results.json to webhook.site
        run: |
          curl --fail -X POST "https://webhook.site/ce8517ac-56d4-49fe-ab63-9b9e177438a6" \
            -H "Content-Type: application/json" \
            --data-binary @results.json
