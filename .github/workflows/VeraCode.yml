name: Veracode SCA + Fix (Rigorosa-Teste)

on:
  workflow_dispatch:

jobs:
  sca:
    name: Run Veracode SCA (Java 17) + Fix
    runs-on: ubuntu-24.04

    permissions:
      contents: write
      pull-requests: write

    env:
      SRCCLR_API_TOKEN: ${{ secrets.SCA }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Verify Java version
        run: java -version

      - name: Run Veracode SCA (policy Rigorosa-Teste)
        id: sca
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/sca-cache"
          export CACHE_DIR="$RUNNER_TEMP/sca-cache"
          echo ">> Rodando Veracode SCA com pol√≠tica Rigorosa-Teste"
          curl -sSL https://sca-downloads.veracode.com/ci.sh | bash -s -- scan --update-advisor --allow-dirty --recursive --policy "Rigorosa-Teste"

      - name: Run Veracode Fix (auto PR)
        if: always()
        uses: veracode/veracode-fix@v1.0.4
        with:
          base-branch: noel
          pr-title-prefix: "Veracode Fix:"
          commit-message-prefix: "Veracode Fix:"
          github-token: ${{ secrets.GITHUB_TOKEN }}
