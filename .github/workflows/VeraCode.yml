name: Veracode Autopackager + Pipeline Scan + Fix (Rigorosa-Teste)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  sast_autofix:
    runs-on: ubuntu-24.04
    permissions:
      contents: write          # criar branch/commits
      pull-requests: write     # abrir/comentar PR

    env:
      VERACODE_API_ID: ${{ secrets.VERACODE_API_ID }}
      VERACODE_API_KEY: ${{ secrets.VERACODE_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Instala o Veracode CLI (coloca no PATH)
      - name: Install Veracode CLI
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://tools.veracode.com/veracode-cli/install | sh
          sudo mv ./veracode /usr/local/bin/veracode
          veracode version

      # 2) Autopackager (não interativo)
      - name: Auto-package source into artifact (non-interactive)
        id: autopack
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p veracode_artifacts
          # Responde aos 2 prompts (trust e save trust)
          printf 'y\ny\n' | veracode package --source . --output veracode_artifacts
          ARTIFACT_PATH="$(ls -1 veracode_artifacts/*.zip | head -n 1)"
          echo "artifact_path=${ARTIFACT_PATH}" >> "$GITHUB_OUTPUT"

      # 3) Pipeline Scan (policy Rigorosa-Teste) com JSON
      - name: Veracode Pipeline Scan (Rigorosa-Teste)
        id: pipeline_scan
        uses: veracode/Veracode-pipeline-scan-action@v1.0.12
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          file: ${{ steps.autopack.outputs.artifact_path }}
          veracode_policy_name: "Rigorosa-Teste"
          fail_build: true
          json_output: true
          json_output_file: "results.json"

      # 4) Veracode Fix — força atuar em TODOS os arquivos suportados
      - name: Veracode Fix (auto PR)
        if: always()
        uses: veracode/veracode-fix@v1.0.4
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          inputFile: results.json
          createPR: true
          prComment: true
          codeSuggestion: true
          fixType: all             # <— chave: não depende do diff do PR
          language: javascript     # ajuda o motor a focar no stack JS
          token: ${{ secrets.GITHUB_TOKEN }}   # credencial para abrir PR
          emailForCommits: "github-actions[bot]@users.noreply.github.com"
